<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1.0" />
	<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
	<meta http-equiv="Pragma" content="no-cache">
	<meta http-equiv="Expires" content="0">
	<title>GLaMS</title>
	<link rel="stylesheet" href="./style.css?12" />
	<script src="https://cdn.jsdelivr.net/gh/makeabilitylab/p5js/_libraries/serial.js"></script>
	<script src="./SwiCC_comms.js?12"></script>
	<script src="./page_funcs.js?12"></script>
	<script>

		// Buffer to delay display outputs
		const timeBuffer = [];
		let oldModCon = '[false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false,false]';
		let oldModStick = '[0,0,0,0]';

		/**
		 * The main loop that runs the gamepad listening and manipulating logic.
		 */
		function mainLoop() {
			// Set next update; could also use requestAnimationFrame(mainLoop);
			setTimeout(mainLoop, 16);

			checkGamepads();
			readGamepad(gamepad_num);

			// Apply mapping
			if (modArrayStale) createMap();
			applyMap();

			// Check for button spam toggle
			if (document.getElementById("auto-jump-checkbox").checked) {
				toggleAutoJump();
			}

			// Apply button spam if enabled
			if (autojump_enabled) {
				applyAutoJump();
			} else {
				forceCon.fill(false);
			}
			// Apply force-pushed buttons
			applyForce();

			updateMapDisplay();
//			updateConDisplay(curCon, modCon, curStick);

			if (!queue_playing) { // Don't send real-time control while playing recording
				packSwitchCon();
				sendConToSwiCC();
			}

			// If delaying, handle the delay
			if (lagAmount > 0) {
				const timestamp = Date.now();
				// Save current data
				timeBuffer.push({
					timestamp,
					delayedModCon: JSON.stringify(modCon),
					delayedModStick: JSON.stringify(modStick)
				});
				// Check for changes that are older than lagAmount and apply them to modCon and modStick
				if (timeBuffer.length > 0) {
					while (timestamp - timeBuffer[0].timestamp >= lagAmount) {
						const delayedValues = timeBuffer.shift();
						oldModCon = delayedValues.delayedModCon;
						oldModStick = delayedValues.delayedModStick;
					}
					localStorage.setItem('GLaMS-modCon', oldModCon);
					localStorage.setItem('GLaMS-modStick', oldModStick);
				}
			} else {
				// No delay; realtime modified data
				localStorage.setItem('GLaMS-modCon', JSON.stringify(modCon));
				localStorage.setItem('GLaMS-modStick', JSON.stringify(modStick));
			}

				// Communicate with other display pages
				localStorage.setItem('GLaMS-curCon', JSON.stringify(curCon));
				localStorage.setItem('GLaMS-curStick', JSON.stringify(curStick));

		}

		// Page onLoad
		document.addEventListener("DOMContentLoaded", function () {
			// Build the tables
			buildMappingTable();
			buildRandomizeTable();
			buildAutoTable();
			// Start the loop
			mainLoop();
		});

	</script>

</head>

<body>
	<main>
		<div id="main-content" class="stack-of-things"> <!-- Main center column -->
			<div class="row-of-things"> <!-- Top row -->
				<div id="control-status" class="stack-of-things">
					<div id="comms-box" class="content-box">
						<div class="status-div" id="status-gamepad">- Gamepad -<br />Use gamepad to connect.</div>
						<div class="status-div" id="status-serial" onclick="connectToSerialDevice()">
							- Comm Port -<br />Click here to connect.</div>
						<div class="status-div" id="status-swicc">- SwiCC -<br />Not detected.</div>
					</div>
					<iframe id="gamepad-iframe" class="content-box" style="height:100%;" src="./inoutCon.html" frameborder="0">
						<!-- The gamepad display -->
					</iframe>
					<div class="content-box">
						<div class="row-of-things">
							<div class="stack-of-things">
								<div class="btny-div" id="status-stick2dpad" onclick="toggleStick2Dpad(1)">Convert left stick to dpad</div>
							</div>
							<div class="stack-of-things">
								<div class="btny-div" id="status-stick2abxy" onclick="toggleStick2Dpad(2)">Convert right stick to ABXY</div>
							</div>
							<div class="stack-of-things">
								Rotate stick outputs (CW degrees [-180,180]):
								<div class="row-of-things">
									<div class="btny-div" style="width:max-content;" id="rot-down" onclick="changeRotation(-10)">CCW 10</div>
									<input type="text" id="rotate-amt" style="border:1px solid black" value="0" onChange="setRotation()">
									<div class="btny-div" style="width:max-content;" id="rot-up" onclick="changeRotation(10)">CW 10</div>
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="content-box"> <!-- Right side of top row -->
					<div id="map-status" class="stack-of-things">
						<div id="mapping-container" class="table-container">
							Input (top) to output (right) mapping.<br /><br />
							<!-- mapping table -->
						</div>
						<div class="btny-div" onclick="randomizeMap(1)">Reset</div>
						<br />
						<div id="randomize-container" class="table-container">
							Enable randomization:<br /><br />
							<!-- randomization table -->
						</div>
						<div class="btny-div" onclick="randomizeMap(0)">Randomize</div>
					</div>
				</div>
			</div>
			<div class="row-of-things"> <!-- Other tools -->
				<div class="content-box">
					<div class="stack-of-things">
						Delay (milliseconds):
						<div class="btny-div" id="lag-up" onclick="changeLag(16.66666666666666666)">+16.6 (1 frame)</div>
						<input type="text" id="lag-num" style="border:1px solid black" value="0" onChange="setLag()">
						<div class="btny-div" id="lag-down" onclick="changeLag(-16.6666666666666666)">-16.6 (1 frame)</div>
					</div>
				</div>
				<div class="content-box">
					<div class="stack-of-things">
						Auto-enter Course ID.<br />Type ID here:
						<input type="text" id="level-id" style="border:1px solid black">
						Click ID button in game, then
						<div class="btny-div" onclick="queueID()">Send</div>
					</div>
				</div>

				<div class="content-box">
					<div class="stack-of-things">
						<div>Enable button spam: <input type="checkbox" id="auto-jump-checkbox"></div>
						<div id="auto-container" class="table-container">
							<!-- randomization table -->
						</div>

						(Click right stick in game to toggle)
						<div class="status-div" id="status-autojump">off</div>
					</div>
				</div>

			</div>
		</div>
	</main>
</body>

</html>